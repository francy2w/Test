-- ============================================================
-- CHEIXHUB - COMPLETE VERSION WITH NOTHING UI
-- Complete script for Peroxide/Adopt Me
-- English version
-- ============================================================

-- Load NOTHING library
local NothingLibrary = loadstring(game:HttpGetAsync('https://raw.githubusercontent.com/3345-c-a-t-s-u-s/NOTHING/main/source.lua'))();
local Notification = NothingLibrary.Notification();

-- Global configuration
getgenv().CHEIXHUB_CONFIG = {
    -- Keybinds
    TELEPORT_KEYBIND       = Enum.KeyCode.T,
    TOGGLE_GUI_KEYBIND     = Enum.KeyCode.RightControl,
    INSTANT_CLONER_KEYBIND = Enum.KeyCode.C,
    KICK_SELF_KEYBIND      = Enum.KeyCode.K,
    FLOOR_STEAL_KEYBIND    = Enum.KeyCode.F,
    REJOIN_KEYBIND         = Enum.KeyCode.R,
    DESYNC_KEYBIND         = Enum.KeyCode.V,

    -- Main Features
    AUTO_TP_ENABLED        = false,
    AUTO_HIDE_ENABLED      = false,
    AUTO_STEAL_ENABLED     = false,
    AUTO_STEAL_NEAREST_ENABLED = false,
    AUTO_STEAL_PRIORITY_ENABLED = false,
    PREDICTIVE_STEAL       = true,
    OptimizerEnabled       = false,
    FLOOR_STEAL_ENABLED    = false,
    AUTO_DESYNC_ENABLED    = false,
    STEAL_SPEED_ENABLED    = false,
    STEAL_DISABLE_ANIM_ENABLED = false,
    
    -- Filters
    SHOW_ALL_RARITIES      = true,
    SHOW_MUTATIONS_ONLY    = false,
    SHOW_TRAITS_ONLY       = false,
    MIN_GEN_VALUE          = 0,
    
    -- Priority System
    FAVORITES_PRIORITY_ENABLED = false,
    INVISIBLE_BASE_WALLS_ENABLED = false,
    SAFE_TELEPORT  = true,
    CARPET_MIDDLE  = false,
    
    -- ESP
    ESP_ENABLED         = false,
    ESP_PLAYERS_ENABLED = false,
    
    -- Anti-Lag
    ANTI_LAG_ENABLED    = false,
    ANTI_BEE_DISCO_ENABLED = false,
    ANTI_RAGDOLL_V1_ENABLED = false,
    ANTI_RAGDOLL_V2_ENABLED = false,
}

local PRIORITY_ANIMALS = {
    "Strawberry Elephant",
    "Meowl",
    "Headless Horseman",
    "Dragon Cannelloni",
    "Capitano Moby",
    "Cooki and Milki",
    "La Supreme Combinasion",
    "Burguro and Fryuro",
    "Garama and Madundung",
    "Lavadorito Spinito",
    "Spooky and Pumpky",
    "La Casa Boo",
    "La Secret Combinasion",
    "Chillin Chili",
    "Ketchuru and Musturu",
    "Ketupat Kepat",
    "La Taco Combinasion",
    "Tang Tang Keletang",
    "Tictac Sahur",
    "W or L",
    "Spaghetti Tualetti",
    "Nuclearo Dinossauro",
    "Money Money Puggy"
}

local CONFIG = getgenv().CHEIXHUB_CONFIG

if not getgenv().CHEIXHUB_FAVORITES then
    getgenv().CHEIXHUB_FAVORITES = {}
end

local FAVORITES = getgenv().CHEIXHUB_FAVORITES

-- Services
local S = {
    Players = game:GetService("Players"),
    UserInputService = game:GetService("UserInputService"),
    TweenService = game:GetService("TweenService"),
    ReplicatedStorage = game:GetService("ReplicatedStorage"),
    HttpService = game:GetService("HttpService"),
    RunService = game:GetService("RunService"),
    Stats = game:GetService("Stats"),
    TeleportService = game:GetService("TeleportService"),
    Lighting = game:GetService("Lighting"),
    CoreGui = game:GetService("CoreGui"),
}

S.LocalPlayer = S.Players.LocalPlayer
S.PlayerGui = S.LocalPlayer:WaitForChild("PlayerGui")

-- Game modules
S.Packages = S.ReplicatedStorage:WaitForChild("Packages")
S.Datas = S.ReplicatedStorage:WaitForChild("Datas")
S.Shared = S.ReplicatedStorage:WaitForChild("Shared")
S.Utils = S.ReplicatedStorage:WaitForChild("Utils")

-- Load modules with protection
local function safeRequire(module)
    local success, result = pcall(function()
        return require(module)
    end)
    return success and result or nil
end

S.Synchronizer = safeRequire(S.Packages:WaitForChild("Synchronizer"))
S.AnimalsData = safeRequire(S.Datas:WaitForChild("Animals"))
S.RaritiesData = safeRequire(S.Datas:WaitForChild("Rarities"))
S.AnimalsShared = safeRequire(S.Shared:WaitForChild("Animals"))
S.NumberUtils = safeRequire(S.Utils:WaitForChild("NumberUtils"))

-- Global state
local allAnimalsCache = {}
local guiVisible = true
local searchQuery = ""
local isCloning = false
local highestAnimal = nil

-- Variables for NOTHING UI
local CheixHubWindow
local AnimalsTab, FavoritesTab, ActionsTab, StatsTab
local animalListContainer, favoritesListContainer
local statsLabels = {}

-- ESP system
local ESP_INSTANCES = {}
local PLAYER_ESP = {}
local ESP_BEST_UID = nil

-- Statistics
local stats = {
    totalAnimals  = 0,
    totalValue    = 0,
    highestGen    = 0,
    mutationCount = 0,
    traitCount    = 0,
}

-- Scanner connections
local scannerConnections = {}
local plotChannels = {}
local lastAnimalData = {}

-- Auto-steal system
local InternalStealCache = {}
local AUTO_STEAL_PROX_RADIUS = 20
local PromptMemoryCache = {}
local LastTargetUID = nil
local LastPlayerPosition = nil
local PlayerVelocity = Vector3.zero
local PREDICTION_LOOKAHEAD = 1.25

-- Speed variables
local STEAL_SPEED = 25.5
local stealSpeedConn = nil

-- Optimization variables
local floatPlatform = nil
local invisibleWallsLoaded = false
local originalTransparency = {}

-- Animation system
local animDisableConn = nil
local originalAnimIds = {}
local animateScript = nil

-- ============================================================
-- UTILITY FUNCTIONS
-- ============================================================

-- Notification function
local function showNotification(title, description, duration, icon)
    duration = duration or 3
    icon = icon or "rbxassetid://7733993369"
    
    Notification.new({
        Title = title,
        Description = description,
        Duration = duration,
        Icon = icon
    })
end

-- Save configuration
local function saveConfig()
    local serializableConfig = {}
    
    for k, v in pairs(CONFIG) do
        if typeof(v) == "EnumItem" then
            serializableConfig[k] = {
                _type = "EnumItem",
                _enumType = tostring(v.EnumType),
                _name = v.Name
            }
        else
            serializableConfig[k] = v
        end
    end
    
    local success, jsonData = pcall(S.HttpService.JSONEncode, S.HttpService, serializableConfig)
    if success then
        writefile("CheixHubConfig.json", jsonData)
    end
end

-- Load configuration
local function loadConfig()
    if not isfile("CheixHubConfig.json") then return end
    
    local success, jsonData = pcall(readfile, "CheixHubConfig.json")
    if not success then return end
    
    local success2, savedConfig = pcall(S.HttpService.JSONDecode, S.HttpService, jsonData)
    if not success2 then return end
    
    for k, v in pairs(savedConfig) do
        if type(v) == "table" and v._type == "EnumItem" then
            local enumType = v._enumType
            local enumName = v._name
            
            if enumType == "KeyCode" and Enum.KeyCode[enumName] then
                CONFIG[k] = Enum.KeyCode[enumName]
            end
        else
            CONFIG[k] = v
        end
    end
end

-- Save favorites
local function saveFavorites()
    local success, jsonData = pcall(S.HttpService.JSONEncode, S.HttpService, FAVORITES)
    if success then
        writefile("CheixHubFavorites.json", jsonData)
    end
end

-- Load favorites
local function loadFavorites()
    if not isfile("CheixHubFavorites.json") then return end
    
    local success, jsonData = pcall(readfile, "CheixHubFavorites.json")
    if not success then return end
    
    local success2, savedFavorites = pcall(S.HttpService.JSONDecode, S.HttpService, jsonData)
    if success2 and savedFavorites then
        for _, name in ipairs(savedFavorites) do
            table.insert(FAVORITES, name)
        end
        getgenv().CHEIXHUB_FAVORITES = FAVORITES
    end
end

-- ============================================================
-- FAVORITES SYSTEM
-- ============================================================

local function isFavorite(animalName)
    for _, name in ipairs(FAVORITES) do
        if name:lower() == animalName:lower() then
            return true
        end
    end
    return false
end

local function addFavorite(animalName)
    for _, name in ipairs(FAVORITES) do
        if name:lower() == animalName:lower() then
            showNotification("Favorites", "Already in favorites: " .. animalName, 3)
            return false
        end
    end
    
    table.insert(FAVORITES, animalName)
    saveFavorites()
    showNotification("Favorites", "âœ“ Added to favorites: " .. animalName, 3)
    return true
end

local function removeFavorite(animalName)
    for i, name in ipairs(FAVORITES) do
        if name:lower() == animalName:lower() then
            table.remove(FAVORITES, i)
            saveFavorites()
            showNotification("Favorites", "âœ— Removed from favorites: " .. animalName, 3)
            return true
        end
    end
    return false
end

local function getFavoriteByPriority()
    for _, favName in ipairs(FAVORITES) do
        for _, animal in ipairs(allAnimalsCache) do
            if animal.name:lower() == favName:lower() then
                return animal
            end
        end
    end
    return nil
end

-- ============================================================
-- DESYNC SYSTEM
-- ============================================================

local DESYNC_FLAGS = {
    LargeReplicatorEnabled9 = true,
    GameNetDontSendRedundantNumTimes = 1,
    MaxTimestepMultiplierAcceleration = 2147483647,
    InterpolationFrameVelocityThresholdMillionth = 5,
    CheckPVDifferencesForInterpolationMinRotVelThresholdRadsPerSecHundredth = 1,
    TimestepArbiterVelocityCriteriaThresholdTwoDt = 2147483646,
    GameNetPVHeaderLinearVelocityZeroCutoffExponent = -5000,
    TimestepArbiterHumanoidTurningVelThreshold = 1,
    LargeReplicatorSerializeWrite4 = true,
    SimExplicitlyCappedTimestepMultiplier = 2147483646,
    InterpolationFrameRotVelocityThresholdMillionth = 5,
    ServerMaxBandwith = 52,
    LargeReplicatorSerializeRead3 = true,
    GameNetDontSendRedundantDeltaPositionMillionth = 1,
    PhysicsSenderMaxBandwidthBps = 20000,
    CheckPVCachedVelThresholdPercent = 10,
    NextGenReplicatorEnabledWrite4 = true,
    LargeReplicatorWrite5 = true,
    MaxMissedWorldStepsRemembered = -2147483648,
    StreamJobNOUVolumeCap = 2147483647,
    CheckPVLinearVelocityIntegrateVsDeltaPositionThresholdPercent = 1,
    DisableDPIScale = true,
    WorldStepMax = 30,
    InterpolationFramePositionThresholdMillionth = 5,
    MaxAcceptableUpdateDelay = 1,
    TimestepArbiterOmegaThou = 1073741823,
    CheckPVCachedRotVelThresholdPercent = 10,
    StreamJobNOUVolumeLengthCap = 2147483647,
    S2PhysicsSenderRate = 15000,
    MaxTimestepMultiplierBuoyancy = 2147483647,
    SimOwnedNOUCountThresholdMillionth = 2147483647,
    ReplicationFocusNouExtentsSizeCutoffForPauseStuds = 2147483647,
    LargeReplicatorRead5 = true,
    CheckPVDifferencesForInterpolationMinVelThresholdStudsPerSecHundredth = 1,
    MaxDataPacketPerSend = 2147483647,
    MaxTimestepMultiplierContstraint = 2147483647,
    DebugSendDistInSteps = -2147483648,
    GameNetPVHeaderRotationalVelocityZeroCutoffExponent = -5000,
    AngularVelociryLimit = 360
}

local function runDesyncEngine()
    for key, value in pairs(DESYNC_FLAGS) do
        pcall(function()
            setfflag(tostring(key), tostring(value))
        end)
    end
end

local function enableDesync()
    task.spawn(runDesyncEngine)
    showNotification("Desync V3", "Desync activated with no lagback", 3)
end

-- ============================================================
-- ESP SYSTEM
-- ============================================================

local function isMyBaseAnimal(animalData)
    if not animalData or not animalData.plot then
        return false
    end
    
    local plots = workspace:FindFirstChild("Plots")
    if not plots then
        return false
    end
    
    local plot = plots:FindFirstChild(animalData.plot)
    if not plot then
        return false
    end
    
    local channel = S.Synchronizer:Get(plot.Name)
    if channel then
        local owner = channel:Get("Owner")
        if owner then
            if typeof(owner) == "Instance" and owner:IsA("Player") then
                return owner.UserId == S.LocalPlayer.UserId
            elseif typeof(owner) == "table" and owner.UserId then
                return owner.UserId == S.LocalPlayer.UserId
            elseif typeof(owner) == "Instance" then
                return owner == S.LocalPlayer
            end
        end
    end
    
    local sign = plot:FindFirstChild("PlotSign")
    if sign then
        local yourBase = sign:FindFirstChild("YourBase")
        if yourBase and yourBase:IsA("BillboardGui") then
            return yourBase.Enabled == true
        end
    end
    
    return false
end

local function clearESPForUID(uid)
    local rec = ESP_INSTANCES[uid]
    if not rec then return end
    if rec.highlight then pcall(function() rec.highlight:Destroy() end) end
    if rec.billboard then pcall(function() rec.billboard:Destroy() end) end
    ESP_INSTANCES[uid] = nil
end

local function clearAllESP()
    for uid in pairs(ESP_INSTANCES) do
        clearESPForUID(uid)
    end
    ESP_BEST_UID = nil
end

local function getPodiumWorldPart(animal)
    if not animal.plot or not animal.slot then return nil end
    
    local plot = workspace.Plots:FindFirstChild(animal.plot)
    if not plot then return nil end
    
    local podiums = plot:FindFirstChild("AnimalPodiums")
    if not podiums then return nil end
    
    local podium = podiums:FindFirstChild(animal.slot)
    if not podium then return nil end
    
    local base = podium:FindFirstChild("Base")
    if not base then return podium end
    
    local spawn = base:FindFirstChild("Spawn")
    return spawn or base or podium
end

local function refreshAllESP()
    if not S.PlayerGui then return end
    
    if not CONFIG.ESP_ENABLED then
        clearAllESP()
        return
    end
    
    local activeUIDs = {}
    local bestAnimal = nil
    
    -- Find best animal that's NOT from your base
    for _, animalData in ipairs(allAnimalsCache) do
        if not isMyBaseAnimal(animalData) then
            bestAnimal = animalData
            break
        end
    end
    
    ESP_BEST_UID = bestAnimal and bestAnimal.uid or nil
    
    for _, animalData in ipairs(allAnimalsCache) do
        -- IMPORTANT: Skip your own base animals
        if isMyBaseAnimal(animalData) then
            continue
        end
        
        if (animalData.uid == ESP_BEST_UID) or (animalData.genValue >= 50000000) then
            local uid = animalData.uid
            activeUIDs[uid] = true
            
            local rec = ESP_INSTANCES[uid]
            local model = getPodiumWorldPart(animalData)
            
            if not model then
                if rec then clearESPForUID(uid) end
                ESP_INSTANCES[uid] = nil
            else
                if not rec or rec.part ~= model then
                    if rec then clearESPForUID(uid) end
                    
                    rec = { part = model }
                    
                    local highlight = Instance.new("Highlight")
                    highlight.Adornee = model
                    highlight.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop
                    highlight.FillTransparency = 0.7
                    highlight.FillColor = Color3.fromRGB(220, 120, 255)
                    highlight.OutlineTransparency = 0.5
                    highlight.OutlineColor = Color3.fromRGB(255, 180, 255)
                    highlight.Parent = S.CoreGui
                    rec.highlight = highlight
                    
                    local bb = Instance.new("BillboardGui")
                    bb.Name = "CheixHubESP"
                    bb.Adornee = model
                    bb.AlwaysOnTop = true
                    bb.Size = UDim2.new(0, 220, 0, 80)
                    bb.StudsOffset = Vector3.new(0, 3.5, 0)
                    bb.Parent = S.CoreGui
                    
                    local bgFrame = Instance.new("Frame")
                    bgFrame.Size = UDim2.new(1, 0, 1, 0)
                    bgFrame.BackgroundColor3 = Color3.fromRGB(100, 50, 150)
                    bgFrame.BackgroundTransparency = 0.8
                    bgFrame.BorderSizePixel = 0
                    bgFrame.Parent = bb
                    
                    local corner = Instance.new("UICorner")
                    corner.CornerRadius = UDim.new(0, 10)
                    corner.Parent = bgFrame
                    
                    local nameLabel = Instance.new("TextLabel")
                    nameLabel.Size = UDim2.new(1, -10, 0.5, 0)
                    nameLabel.Position = UDim2.new(0, 5, 0, 5)
                    nameLabel.BackgroundTransparency = 1
                    nameLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
                    nameLabel.TextScaled = true
                    nameLabel.Font = Enum.Font.GothamBold
                    nameLabel.TextStrokeTransparency = 0
                    nameLabel.TextStrokeColor3 = Color3.fromRGB(0, 0, 0)
                    nameLabel.Text = animalData.name
                    nameLabel.Parent = bgFrame
                    
                    local genLabel = Instance.new("TextLabel")
                    genLabel.Size = UDim2.new(1, -10, 0.5, -5)
                    genLabel.Position = UDim2.new(0, 5, 0.5, 0)
                    genLabel.BackgroundTransparency = 1
                    genLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
                    genLabel.TextScaled = true
                    genLabel.Font = Enum.Font.GothamBold
                    genLabel.TextStrokeTransparency = 0
                    genLabel.TextStrokeColor3 = Color3.fromRGB(0, 0, 0)
                    genLabel.Text = animalData.genText
                    genLabel.Parent = bgFrame
                    
                    rec.billboard = bb
                    rec.labelName = nameLabel
                    rec.labelGen = genLabel
                    
                    ESP_INSTANCES[uid] = rec
                end
            end
        end
    end
    
    for uid in pairs(ESP_INSTANCES) do
        if not activeUIDs[uid] then
            clearESPForUID(uid)
        end
    end
end

-- ============================================================
-- PLAYER ESP SYSTEM
-- ============================================================

local function clearPlayerESP(plr)
    local rec = PLAYER_ESP[plr]
    if not rec then return end
    
    if rec.highlightMain then pcall(function() rec.highlightMain:Destroy() end) end
    if rec.highlightSoft then pcall(function() rec.highlightSoft:Destroy() end) end
    if rec.billboard then pcall(function() rec.billboard:Destroy() end) end
    
    PLAYER_ESP[plr] = nil
end

local function clearAllPlayerESP()
    for plr in pairs(PLAYER_ESP) do
        clearPlayerESP(plr)
    end
end

local function createPlayerESP(plr)
    local char = plr.Character
    if not char then return end
    
    local hrp = char:FindFirstChild("HumanoidRootPart") or char:FindFirstChild("UpperTorso") or char.PrimaryPart
    if not hrp then return end
    
    local rec = {}
    
    local hMain = Instance.new("Highlight")
    hMain.Adornee = char
    hMain.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop
    hMain.FillTransparency = 1
    hMain.OutlineTransparency = 0
    hMain.OutlineColor = Color3.fromRGB(220, 120, 255)
    hMain.Parent = S.CoreGui
    rec.highlightMain = hMain
    
    local hSoft = Instance.new("Highlight")
    hSoft.Adornee = char
    hSoft.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop
    hSoft.FillTransparency = 1
    hSoft.OutlineTransparency = 0
    hSoft.OutlineColor = Color3.new(0.345098, 0.066667, 0.952941)
    hSoft.Parent = S.CoreGui
    rec.highlightSoft = hSoft
    
    local bb = Instance.new("BillboardGui")
    bb.Size = UDim2.new(0, 160, 0, 32)
    bb.Adornee = hrp
    bb.AlwaysOnTop = true
    bb.StudsOffset = Vector3.new(0, 3.2, 0)
    bb.Parent = S.CoreGui
    rec.billboard = bb
    
    local nameLabel = Instance.new("TextLabel")
    nameLabel.Size = UDim2.new(1, 0, 1, 0)
    nameLabel.BackgroundTransparency = 1
    nameLabel.TextColor3 = Color3.fromRGB(120, 240, 255)
    nameLabel.TextStrokeColor3 = Color3.fromRGB(0, 0, 0)
    nameLabel.TextStrokeTransparency = 0.3
    nameLabel.TextScaled = true
    nameLabel.Font = Enum.Font.GothamBold
    nameLabel.Text = plr.Name
    nameLabel.Parent = bb
    rec.nameLabel = nameLabel
    
    PLAYER_ESP[plr] = rec
end

local function refreshPlayerESP()
    if not CONFIG.ESP_PLAYERS_ENABLED then
        clearAllPlayerESP()
        return
    end
    
    for _, plr in ipairs(S.Players:GetPlayers()) do
        if plr ~= S.LocalPlayer then
            if not PLAYER_ESP[plr] then
                createPlayerESP(plr)
            end
        end
    end
    
    local myChar = S.LocalPlayer.Character
    local myHRP = myChar and (myChar:FindFirstChild("HumanoidRootPart") or myChar:FindFirstChild("UpperTorso") or myChar.PrimaryPart)
    
    for plr, rec in pairs(PLAYER_ESP) do
        local char = plr.Character
        local hrp = char and (char:FindFirstChild("HumanoidRootPart") or char:FindFirstChild("UpperTorso") or char.PrimaryPart)
        
        if not char or not hrp or not myHRP then
            clearPlayerESP(plr)
        else
            local dist = (myHRP.Position - hrp.Position).Magnitude
            local distInt = math.floor(dist + 0.5)
            
            if rec.nameLabel then
                rec.nameLabel.Text = string.format("%s [%dm]", plr.Name, distInt)
            end
        end
    end
end

local function playerESPHeartbeat()
    if CONFIG.ESP_PLAYERS_ENABLED then
        refreshPlayerESP()
    end
end

-- ============================================================
-- FLOOR STEAL & INVISIBLE WALLS SYSTEM
-- ============================================================

local function getHRP()
    local c = S.LocalPlayer.Character
    if not c then return end
    return c:FindFirstChild("HumanoidRootPart") or c:FindFirstChild("UpperTorso")
end

local function startFloorSteal()
    if floatPlatform then floatPlatform:Destroy() end
    
    floatPlatform = Instance.new("Part")
    floatPlatform.Size = Vector3.new(6, 1, 6)
    floatPlatform.Anchored = true
    floatPlatform.CanCollide = true
    floatPlatform.Transparency = 1
    floatPlatform.Parent = workspace
    
    task.spawn(function()
        while CONFIG.FLOOR_STEAL_ENABLED and floatPlatform do
            local hrp = getHRP()
            if hrp then
                floatPlatform.Position = hrp.Position - Vector3.new(0, 3, 0)
            end
            task.wait(0.05)
        end
    end)
end

local function stopFloorSteal()
    if floatPlatform then
        floatPlatform:Destroy()
        floatPlatform = nil
    end
end

local function isBaseWall(obj)
    if not obj:IsA("BasePart") then return false end
    local n = obj.Name:lower()
    local parent = obj.Parent and obj.Parent.Name:lower() or ""
    return n:find("base") or parent:find("base")
end

local function tryApplyInvisibleWalls()
    if not CONFIG.INVISIBLE_BASE_WALLS_ENABLED then return end
    
    local plots = workspace:FindFirstChild("Plots")
    if not plots then return end
    if #plots:GetChildren() == 0 then return end
    
    if invisibleWallsLoaded then return end
    invisibleWallsLoaded = true
    
    for _, obj in ipairs(workspace:GetDescendants()) do
        if obj:IsA("BasePart") and obj.Anchored and obj.CanCollide and isBaseWall(obj) then
            originalTransparency[obj] = obj.LocalTransparencyModifier
            obj.LocalTransparencyModifier = 0.85
        end
    end
    
    workspace.DescendantAdded:Connect(function(obj)
        if CONFIG.INVISIBLE_BASE_WALLS_ENABLED and isBaseWall(obj) then
            originalTransparency[obj] = obj.LocalTransparencyModifier
            obj.LocalTransparencyModifier = 0.85
        end
    end)
end

local function enableInvisibleBaseWalls()
    CONFIG.INVISIBLE_BASE_WALLS_ENABLED = true
    
    task.spawn(function()
        for _ = 1, 20 do
            tryApplyInvisibleWalls()
            if invisibleWallsLoaded then return end
            task.wait(0.5)
        end
    end)
end

local function disableInvisibleBaseWalls()
    CONFIG.INVISIBLE_BASE_WALLS_ENABLED = false
    invisibleWallsLoaded = false
    
    for part, value in pairs(originalTransparency) do
        if part then
            part.LocalTransparencyModifier = value
        end
    end
    originalTransparency = {}
end

-- ============================================================
-- AUTO-STEAL SYSTEM
-- ============================================================

local function findProximityPromptForAnimal(animalData)
    if not animalData then return nil end
    
    local cachedPrompt = PromptMemoryCache[animalData.uid]
    if cachedPrompt and cachedPrompt.Parent then
        return cachedPrompt
    end
    
    local plot = workspace.Plots:FindFirstChild(animalData.plot)
    if not plot then return nil end
    
    local podiums = plot:FindFirstChild("AnimalPodiums")
    if not podiums then return nil end
    
    local podium = podiums:FindFirstChild(animalData.slot)
    if not podium then return nil end
    
    local base = podium:FindFirstChild("Base")
    if not base then return nil end
    
    local spawn = base:FindFirstChild("Spawn")
    if not spawn then return nil end
    
    local attach = spawn:FindFirstChild("PromptAttachment")
    if not attach then return nil end
    
    for _, p in ipairs(attach:GetChildren()) do
        if p:IsA("ProximityPrompt") then
            PromptMemoryCache[animalData.uid] = p
            return p
        end
    end
    
    return nil
end

local function getAnimalPosition(animalData)
    local plot = workspace.Plots:FindFirstChild(animalData.plot)
    if not plot then return nil end
    
    local podiums = plot:FindFirstChild("AnimalPodiums")
    if not podiums then return nil end
    
    local podium = podiums:FindFirstChild(animalData.slot)
    if not podium then return nil end
    
    return podium:GetPivot().Position
end

local function getNearestAnimal()
    local hrp = getHRP()
    if not hrp then return nil end
    
    local nearest = nil
    local minDist = math.huge
    
    for _, animalData in ipairs(allAnimalsCache) do
        -- IMPORTANT: Skip your own base animals
        if isMyBaseAnimal(animalData) then
            continue
        end
        
        local pos = getAnimalPosition(animalData)
        if pos then
            local dist = (hrp.Position - pos).Magnitude
            
            if dist < minDist then
                minDist = dist
                nearest = animalData
            end
        end
    end
    
    return nearest
end

local function updatePlayerVelocity()
    local hrp = getHRP()
    if not hrp then return end
    
    local currentPos = hrp.Position
    
    if LastPlayerPosition then
        PlayerVelocity = (currentPos - LastPlayerPosition) / task.wait()
    end
    
    LastPlayerPosition = currentPos
end

local function getTimeToReach(targetPos)
    local hrp = getHRP()
    if not hrp then return math.huge end
    
    local currentPos = hrp.Position
    local distance = (targetPos - currentPos).Magnitude
    
    if PlayerVelocity.Magnitude < 0.1 then
        return math.huge
    end
    
    local directionToTarget = (targetPos - currentPos).Unit
    local velocityTowardTarget = PlayerVelocity:Dot(directionToTarget)
    
    if velocityTowardTarget <= 0 then
        return math.huge
    end
    
    return distance / velocityTowardTarget
end

local function shouldPreFire(animalData)
    local animalPos = getAnimalPosition(animalData)
    if not animalPos then return false end
    
    local hrp = getHRP()
    if not hrp then return false end
    
    local currentDistance = (hrp.Position - animalPos).Magnitude
    
    if currentDistance <= AUTO_STEAL_PROX_RADIUS then
        return true
    end
    
    if not CONFIG.PREDICTIVE_STEAL then
        return false
    end
    
    local timeToReach = getTimeToReach(animalPos)
    
    if timeToReach <= PREDICTION_LOOKAHEAD and timeToReach > 0 then
        return true
    end
    
    return false
end

local function buildStealCallbacks(prompt)
    if InternalStealCache[prompt] then return end
    
    local data = {
        holdCallbacks = {},
        triggerCallbacks = {},
        ready = true,
    }
    
    local ok1, conns1 = pcall(getconnections, prompt.PromptButtonHoldBegan)
    if ok1 and type(conns1) == "table" then
        for _, conn in ipairs(conns1) do
            if type(conn.Function) == "function" then
                table.insert(data.holdCallbacks, conn.Function)
            end
        end
    end
    
    local ok2, conns2 = pcall(getconnections, prompt.Triggered)
    if ok2 and type(conns2) == "table" then
        for _, conn in ipairs(conns2) do
            if type(conn.Function) == "function" then
                table.insert(data.triggerCallbacks, conn.Function)
            end
        end
    end
    
    if (#data.holdCallbacks > 0) or (#data.triggerCallbacks > 0) then
        InternalStealCache[prompt] = data
    end
end

local function runCallbackList(list)
    for _, fn in ipairs(list) do
        task.spawn(fn)
    end
end

local function executeInternalStealAsync(prompt)
    local data = InternalStealCache[prompt]
    if not data or not data.ready then return false end
    
    data.ready = false
    
    task.spawn(function()
        if #data.holdCallbacks > 0 then
            runCallbackList(data.holdCallbacks)
        end
        
        task.wait(1.3)
        
        if #data.triggerCallbacks > 0 then
            runCallbackList(data.triggerCallbacks)
        end
        
        task.wait()
        data.ready = true
    end)
    
    return true
end

local function attemptSteal(prompt)
    if not prompt or not prompt.Parent then
        return false
    end
    
    buildStealCallbacks(prompt)
    if not InternalStealCache[prompt] then
        return false
    end
    
    return executeInternalStealAsync(prompt)
end

local function prebuildStealCallbacks()
    for uid, prompt in pairs(PromptMemoryCache) do
        if prompt and prompt.Parent then
            buildStealCallbacks(prompt)
        end
    end
end

local function getPriorityAnimal()
    for _, priorityName in ipairs(PRIORITY_ANIMALS) do
        for _, animalData in ipairs(allAnimalsCache) do
            if not isMyBaseAnimal(animalData) and animalData.name == priorityName then
                return animalData
            end
        end
    end
    return nil
end

local stealConnection = nil
local velocityConnection = nil

local function autoStealLoop()
    if stealConnection then
        stealConnection:Disconnect()
    end
    if velocityConnection then
        velocityConnection:Disconnect()
    end
    
    velocityConnection = S.RunService.Heartbeat:Connect(function()
        updatePlayerVelocity()
    end)
    
    stealConnection = S.RunService.Heartbeat:Connect(function()
        if not CONFIG.AUTO_STEAL_ENABLED and not CONFIG.AUTO_STEAL_NEAREST_ENABLED and not CONFIG.AUTO_STEAL_PRIORITY_ENABLED then
            return
        end
        
        local targetAnimal = nil
        
        if CONFIG.AUTO_STEAL_PRIORITY_ENABLED then
            targetAnimal = getPriorityAnimal()
            
            if not targetAnimal then
                if CONFIG.AUTO_STEAL_NEAREST_ENABLED then
                    targetAnimal = getNearestAnimal()
                elseif CONFIG.AUTO_STEAL_ENABLED then
                    for _, animal in ipairs(allAnimalsCache) do
                        if not isMyBaseAnimal(animal) then
                            targetAnimal = animal
                            break
                        end
                    end
                end
            end
        elseif CONFIG.AUTO_STEAL_NEAREST_ENABLED then
            targetAnimal = getNearestAnimal()
        elseif CONFIG.AUTO_STEAL_ENABLED then
            for _, animal in ipairs(allAnimalsCache) do
                if not isMyBaseAnimal(animal) then
                    targetAnimal = animal
                    break
                end
            end
        end
        
        if not targetAnimal or isMyBaseAnimal(targetAnimal) then
            return
        end
        
        if not shouldPreFire(targetAnimal) then
            return
        end
        
        if LastTargetUID ~= targetAnimal.uid then
            LastTargetUID = targetAnimal.uid
        end
        
        local prompt = PromptMemoryCache[targetAnimal.uid]
        if not prompt or not prompt.Parent then
            prompt = findProximityPromptForAnimal(targetAnimal)
        end
        
        if prompt then
            attemptSteal(prompt)
        end
    end)
end

-- ============================================================
-- SPEED SYSTEM
-- ============================================================

local function startStealSpeed()
    if stealSpeedConn then return end

    stealSpeedConn = S.RunService.Heartbeat:Connect(function()
        if not CONFIG.STEAL_SPEED_ENABLED then return end
        if not S.LocalPlayer:GetAttribute("Stealing") then return end

        local char = S.LocalPlayer.Character
        if not char then return end
        local hum = char:FindFirstChildOfClass("Humanoid")
        local hrp = char:FindFirstChild("HumanoidRootPart")
        if not hum or not hrp then return end

        local move = hum.MoveDirection
        if move.Magnitude > 0 then
            hrp.AssemblyLinearVelocity = Vector3.new(
                move.X * STEAL_SPEED,
                hrp.AssemblyLinearVelocity.Y,
                move.Z * STEAL_SPEED
            )
        end
    end)
end

local function stopStealSpeed()
    if stealSpeedConn then
        stealSpeedConn:Disconnect()
        stealSpeedConn = nil
    end
end

S.LocalPlayer:GetAttributeChangedSignal("Stealing"):Connect(function()
    if S.LocalPlayer:GetAttribute("Stealing") then
        startStealSpeed()
    else
        stopStealSpeed()
    end
end)

-- ============================================================
-- ANIMATION SYSTEM
-- ============================================================

local ANIM_TYPES = {
    "walk", "run", "jump", "fall"
}

local function cacheOriginalAnimations()
    local char = S.LocalPlayer.Character
    if not char then return false end
    
    animateScript = char:FindFirstChild("Animate")
    if not animateScript then return false end
    
    originalAnimIds = {}
    
    for _, animType in ipairs(ANIM_TYPES) do
        local animFolder = animateScript:FindFirstChild(animType)
        if animFolder then
            originalAnimIds[animType] = {}
            for _, anim in ipairs(animFolder:GetChildren()) do
                if anim:IsA("Animation") then
                    originalAnimIds[animType][anim.Name] = anim.AnimationId
                end
            end
        end
    end
    
    return true
end

local function disableAnimations()
    if not animateScript then return end
    
    for _, animType in ipairs(ANIM_TYPES) do
        local animFolder = animateScript:FindFirstChild(animType)
        if animFolder then
            for _, anim in ipairs(animFolder:GetChildren()) do
                if anim:IsA("Animation") then
                    anim.AnimationId = ""
                end
            end
        end
    end
    
    local char = S.LocalPlayer.Character
    if char then
        local hum = char:FindFirstChildOfClass("Humanoid")
        if hum then
            for _, track in ipairs(hum:GetPlayingAnimationTracks()) do
                track:Stop(0)
            end
        end
    end
end

local function restoreAnimations()
    if not animateScript or not originalAnimIds then return end
    
    for animType, anims in pairs(originalAnimIds) do
        local animFolder = animateScript:FindFirstChild(animType)
        if animFolder then
            for animName, animId in pairs(anims) do
                local anim = animFolder:FindFirstChild(animName)
                if anim and anim:IsA("Animation") then
                    anim.AnimationId = animId
                end
            end
        end
    end
end

local function startAnimDisable()
    if animDisableConn then return end
    
    if not next(originalAnimIds) then
        if not cacheOriginalAnimations() then
            return
        end
    end

    animDisableConn = S.RunService.Heartbeat:Connect(function()
        if not CONFIG.STEAL_DISABLE_ANIM_ENABLED then return end
        if not S.LocalPlayer:GetAttribute("Stealing") then return end

        disableAnimations()
    end)
end

local function stopAnimDisable()
    if animDisableConn then
        animDisableConn:Disconnect()
        animDisableConn = nil
    end
    restoreAnimations()
end

S.LocalPlayer:GetAttributeChangedSignal("Stealing"):Connect(function()
    if S.LocalPlayer:GetAttribute("Stealing") then
        if CONFIG.STEAL_DISABLE_ANIM_ENABLED then
            startAnimDisable()
        end
    else
        stopAnimDisable()
    end
end)

S.LocalPlayer.CharacterAdded:Connect(function()
    task.wait(1)
    originalAnimIds = {}
    animateScript = nil
    cacheOriginalAnimations()
end)

-- ============================================================
-- TELEPORT SYSTEM
-- ============================================================

local function teleportToAnimal(animalData)
    local character = S.LocalPlayer.Character
    if not character or not character:FindFirstChild("HumanoidRootPart") then
        showNotification("CheixHub", "Character not found!", 3)
        return false
    end
    
    local humanoid = character:FindFirstChild("Humanoid")
    local hrp = character.HumanoidRootPart
    if not humanoid or not hrp then return false end
    
    -- Equip carpet if available
    local carpet = S.LocalPlayer.Backpack:FindFirstChild("Flying Carpet")
    if carpet then
        humanoid:EquipTool(carpet)
    end
    
    -- Find plot
    local plot = workspace.Plots:FindFirstChild(animalData.plot)
    if not plot then
        showNotification("CheixHub", "Plot not found!", 3)
        return false
    end
    
    -- Find target position
    local targetPos = Vector3.new(0, 10, 0)
    
    local podiums = plot:FindFirstChild("AnimalPodiums")
    local animalFolder = podiums and podiums:FindFirstChild(animalData.slot)
    
    local allParts = {}
    local function scan(obj)
        for _, child in ipairs(obj:GetChildren()) do
            if child:IsA("BasePart") then
                table.insert(allParts, child)
            else
                scan(child)
            end
        end
    end
    
    if animalFolder then
        scan(animalFolder)
    end
    
    if #allParts > 0 then
        local closest, minDist = nil, math.huge
        local hrpPos = hrp.Position
        
        for _, part in ipairs(allParts) do
            local dist = (part.Position - hrpPos).Magnitude
            if dist < minDist then
                minDist = dist
                closest = part
            end
        end
        
        if closest then
            targetPos = closest.Position
        end
    else
        -- Fallback to spawn
        local spawnPart = plot:FindFirstChild("Spawn")
        if spawnPart and spawnPart:IsA("BasePart") then
            targetPos = Vector3.new(spawnPart.Position.X, targetPos.Y, spawnPart.Position.Z)
        else
            local plotPart = plot:FindFirstChildWhichIsA("BasePart")
            if plotPart then
                targetPos = Vector3.new(plotPart.Position.X, targetPos.Y, plotPart.Position.Z)
            end
        end
    end
    
    local animalY = targetPos.Y
    local highAnimal = animalY > 10
    local currentPos = hrp.Position
    
    -- Safe teleport via carpet
    if CONFIG.SAFE_TELEPORT then
        local carpetPart = workspace.Map:FindFirstChild("Carpet")
        if carpetPart and carpetPart:IsA("BasePart") then
            -- Simple teleport to carpet
            hrp.CFrame = CFrame.new(carpetPart.Position + Vector3.new(0, 5, 0))
            task.wait(0.3)
        end
    else
        -- Non-safe teleport
        if highAnimal then
            local state = humanoid:GetState()
            if state ~= Enum.HumanoidStateType.Jumping and state ~= Enum.HumanoidStateType.Freefall then
                humanoid:ChangeState(Enum.HumanoidStateType.Jumping)
                task.wait(0.05)
            end
            
            hrp.Velocity = Vector3.new(hrp.Velocity.X, 200, hrp.Velocity.Z)
            task.wait(0.2)
        end
    end
    
    -- Adjust final position based on height
    local finalPos
    if highAnimal then
        finalPos = Vector3.new(targetPos.X, 20, targetPos.Z)
    else
        finalPos = targetPos
    end
    
    hrp.CFrame = CFrame.new(finalPos)
    
    showNotification("CheixHub", "âœ“ Teleported to " .. animalData.name, 3)
    return true
end

local function teleportToHighest()
    if #allAnimalsCache == 0 then
        showNotification("CheixHub", "No brainrots found yet!", 3)
        return
    end
    
    if CONFIG.FAVORITES_PRIORITY_ENABLED and #FAVORITES > 0 then
        local favAnimal = getFavoriteByPriority()
        if favAnimal then
            showNotification("CheixHub", "ðŸ“Œ Teleporting to priority: " .. favAnimal.name, 3)
            teleportToAnimal(favAnimal)
            return
        else
            showNotification("CheixHub", "âš  No favorites found, using highest gen", 3)
        end
    end
    
    teleportToAnimal(allAnimalsCache[1])
end

local function autoTeleportOnStart()
    task.wait(0.5)
    if #allAnimalsCache > 0 then
        teleportToHighest()
    end
end

-- ============================================================
-- ACTION FUNCTIONS
-- ============================================================

local function instantCloner()
    if isCloning then
        showNotification("CheixHub", "Cloner already in progress!", 3)
        return
    end
    
    isCloning = true
    
    local success, err = pcall(function()
        local character = S.LocalPlayer.Character
        if not character then error("Character not found") end
        
        local humanoid = character:FindFirstChild("Humanoid")
        if not humanoid then error("Humanoid not found") end
        
        for _, tool in ipairs(character:GetChildren()) do
            if tool:IsA("Tool") then
                humanoid:UnequipTools()
                task.wait(0.1)
                break
            end
        end
        
        local backpack = S.LocalPlayer.Backpack
        local cloner = backpack:FindFirstChild("Quantum Cloner")
        if not cloner then error("Quantum Cloner not found in inventory!") end
        
        humanoid:EquipTool(cloner)
        task.wait()
        
        local useRemote = S.ReplicatedStorage:WaitForChild("Packages"):WaitForChild("Net"):WaitForChild("RE/UseItem")
        useRemote:FireServer()
        task.wait()
        
        local clonerRemote = S.ReplicatedStorage:WaitForChild("Packages"):WaitForChild("Net"):WaitForChild("RE/QuantumCloner/OnTeleport")
        clonerRemote:FireServer()
        
        showNotification("Cloner", "âœ“ Instant cloner activated!", 3)
    end)
    
    if not success then
        showNotification("CheixHub", "âœ— Cloner failed: " .. tostring(err), 3)
    end
    
    task.wait(1)
    isCloning = false
end

local function kickSelf()
    showNotification("CheixHub", "Kicking...", 3)
    task.wait()
    S.LocalPlayer:Kick("Kicked by CheixHub")
end

local function rejoinServer()
    local placeId = game.PlaceId
    local jobId = game.JobId
    
    showNotification("CheixHub", "Rejoining current server...", 3)
    
    task.delay(0.15, function()
        local ok, err = pcall(function()
            if jobId and jobId ~= "" then
                S.TeleportService:TeleportToPlaceInstance(placeId, jobId, S.LocalPlayer)
            else
                S.TeleportService:Teleport(placeId, S.LocalPlayer)
            end
        end)
        
        if not ok and err then
            showNotification("CheixHub", "âœ— Rejoin failed: " .. tostring(err), 3)
        end
    end)
end

-- ============================================================
-- SCANNING SYSTEM
-- ============================================================

local function matchesFilters(animalData)
    -- Always ignore your own base animals
    if isMyBaseAnimal(animalData) then
        return false
    end
    
    if searchQuery ~= "" then
        local query = searchQuery:lower()
        if not (animalData.name:lower():find(query) or
                animalData.mutation:lower():find(query) or
                animalData.traits:lower():find(query)) then
            return false
        end
    end
    
    if animalData.genValue < CONFIG.MIN_GEN_VALUE then return false end
    if CONFIG.SHOW_MUTATIONS_ONLY and animalData.mutation == "None" then return false end
    if CONFIG.SHOW_TRAITS_ONLY and animalData.traits == "None" then return false end
    
    return true
end

local function getAnimalHash(animalList)
    if not animalList then return "" end
    local hash = ""
    for slot, data in pairs(animalList) do
        if type(data) == "table" then
            hash = hash .. tostring(slot) .. tostring(data.Index) .. tostring(data.Mutation)
        end
    end
    return hash
end

local function scanSinglePlot(plot)
    pcall(function()        
        local plotUID = plot.Name
        local channel = S.Synchronizer:Get(plotUID)
        if not channel then return end
        
        local animalList = channel:Get("AnimalList")
        local currentHash = getAnimalHash(animalList)
        if lastAnimalData[plotUID] == currentHash then
            return
        end
        lastAnimalData[plotUID] = currentHash
        
        -- Remove old animals from this plot
        for i = #allAnimalsCache, 1, -1 do
            if allAnimalsCache[i].plot == plot.Name then
                table.remove(allAnimalsCache, i)
            end
        end
        
        local owner = channel:Get("Owner")
        if not owner or not S.Players:FindFirstChild(owner.Name) then
            for i = #allAnimalsCache, 1, -1 do
                if allAnimalsCache[i].plot == plot.Name then
                    table.remove(allAnimalsCache, i)
                end
            end
            updateAnimalsList()
            updateStats()
            return
        end
        
        local ownerName = owner and owner.Name or "Unknown"
        if not animalList then return end
        
        for slot, animalData in pairs(animalList) do
            if type(animalData) == "table" then
                local animalName = animalData.Index
                local animalInfo = S.AnimalsData[animalName]
                if not animalInfo then continue end
                
                local rarity = animalInfo.Rarity
                local rarityColor = (S.RaritiesData[rarity] and S.RaritiesData[rarity].Color) or Color3.fromRGB(255, 255, 255)
                
                local mutation = animalData.Mutation or "None"
                local traits = (animalData.Traits and #animalData.Traits > 0) and table.concat(animalData.Traits, ", ") or "None"
                
                local genValue = S.AnimalsShared:GetGeneration(animalName, animalData.Mutation, animalData.Traits, nil)
                local genText = "$" .. (S.NumberUtils and S.NumberUtils:ToString(genValue) or tostring(genValue)) .. "/s"
                
                table.insert(allAnimalsCache, {
                    name = animalInfo.DisplayName or animalName,
                    genText = genText,
                    genValue = genValue,
                    rarity = rarity,
                    rarityColor = rarityColor,
                    mutation = mutation,
                    traits = traits,
                    owner = ownerName,
                    plot = plot.Name,
                    slot = tostring(slot),
                    uid = plot.Name .. "_" .. tostring(slot),
                })
            end
        end
        
        -- Update statistics
        stats = {
            totalAnimals = 0,
            totalValue = 0,
            highestGen = 0,
            mutationCount = 0,
            traitCount = 0,
        }
        
        for _, animal in ipairs(allAnimalsCache) do
            stats.totalAnimals = stats.totalAnimals + 1
            stats.totalValue = stats.totalValue + animal.genValue
            stats.highestGen = math.max(stats.highestGen, animal.genValue)
            if animal.mutation ~= "None" then
                stats.mutationCount = stats.mutationCount + 1
            end
            if animal.traits ~= "None" then
                stats.traitCount = stats.traitCount + 1
            end
        end
        
        -- Sort by generation
        table.sort(allAnimalsCache, function(a, b)
            return a.genValue > b.genValue
        end)
        
        highestAnimal = allAnimalsCache[1]
        
        updateAnimalsList()
        updateStats()
        refreshAllESP()
    end)
end

local function setupPlotListener(plot)
    if plotChannels[plot.Name] then return end
    
    local channel
    local retries = 0
    local maxRetries = 10
    
    while not channel and retries < maxRetries do
        local success, result = pcall(function()
            return S.Synchronizer:Get(plot.Name)
        end)
        if success and result then
            channel = result
            break
        else
            retries = retries + 1
            if retries < maxRetries then
                task.wait(0.5)
            end
        end
    end
    
    if not channel then return end
    plotChannels[plot.Name] = true
    
    scanSinglePlot(plot)
    
    local c1 = plot.DescendantAdded:Connect(function()
        task.wait(0.1)
        scanSinglePlot(plot)
    end)
    table.insert(scannerConnections, c1)
    
    local c2 = plot.DescendantRemoving:Connect(function()
        task.wait(0.1)
        scanSinglePlot(plot)
    end)
    table.insert(scannerConnections, c2)
    
    local c3 = task.spawn(function()
        while plot.Parent and plotChannels[plot.Name] do
            task.wait(5)
            scanSinglePlot(plot)
        end
    end)
    table.insert(scannerConnections, c3)
end

local function initializePlotScanner()
    local plots = workspace:WaitForChild("Plots", 8)
    if not plots then
        showNotification("CheixHub", "âš  Plots folder not found!", 3)
        return
    end
    
    for _, plot in ipairs(plots:GetChildren()) do
        setupPlotListener(plot)
    end
    
    local newPlotConnection = plots.ChildAdded:Connect(function(plot)
        task.wait(0.5)
        setupPlotListener(plot)
    end)
    table.insert(scannerConnections, newPlotConnection)
    
    local removedPlotConnection = plots.ChildRemoved:Connect(function(plot)
        plotChannels[plot.Name] = nil
        lastAnimalData[plot.Name] = nil
        
        for i = #allAnimalsCache, 1, -1 do
            if allAnimalsCache[i].plot == plot.Name then
                table.remove(allAnimalsCache, i)
            end
        end
        
        updateAnimalsList()
        updateStats()
        refreshAllESP()
    end)
    table.insert(scannerConnections, removedPlotConnection)
    
    showNotification("CheixHub", "âœ“ Plot scanner initialized", 3)
end

local function cleanupScanner()
    for _, connection in ipairs(scannerConnections) do
        if typeof(connection) == "RBXScriptConnection" then
            connection:Disconnect()
        elseif typeof(connection) == "thread" then
            task.cancel(connection)
        end
    end
    scannerConnections = {}
    plotChannels = {}
    lastAnimalData = {}
end

local function rescanAllPlots()
    local plots = workspace:FindFirstChild("Plots")
    if not plots then return end
    
    for _, plot in ipairs(plots:GetChildren()) do
        scanSinglePlot(plot)
    end
    showNotification("CheixHub", "âœ“ Rescan completed!", 3)
end

S.Players.PlayerRemoving:Connect(function(player)
    for i = #allAnimalsCache, 1, -1 do
        if allAnimalsCache[i].owner == player.Name then
            table.remove(allAnimalsCache, i)
        end
    end
    updateAnimalsList()
    updateStats()
    refreshAllESP()
end)

-- ============================================================
-- USER INTERFACE
-- ============================================================

-- Function to update animals list
function updateAnimalsList()
    if not animalListContainer then return end
    
    for _, child in ipairs(animalListContainer:GetChildren()) do
        if child:IsA("Frame") then
            child:Destroy()
        end
    end
    
    local displayCount = 0
    for _, animalData in ipairs(allAnimalsCache) do
        if matchesFilters(animalData) then
            local entry = createAnimalEntry(animalData, animalListContainer)
            entry.LayoutOrder = displayCount
            displayCount = displayCount + 1
        end
    end
end

function createAnimalEntry(animalData, parent)
    local rarityColor = animalData.rarityColor or Color3.fromRGB(180, 0, 255)
    local isFav = isFavorite(animalData.name)
    
    local entry = Instance.new("Frame")
    entry.BackgroundColor3 = Color3.fromRGB(35, 35, 45)
    entry.Size = UDim2.new(1, 0, 0, 90)
    
    local entryCorner = Instance.new("UICorner")
    entryCorner.CornerRadius = UDim.new(0, 8)
    entryCorner.Parent = entry
    
    local entryStroke = Instance.new("UIStroke")
    entryStroke.Color = rarityColor
    entryStroke.Thickness = 2
    entryStroke.Parent = entry
    
    -- Accent line
    local accentLine = Instance.new("Frame")
    accentLine.Size = UDim2.new(0, 3, 1, 0)
    accentLine.Position = UDim2.new(0, 0, 0, 0)
    accentLine.BackgroundColor3 = rarityColor
    accentLine.Parent = entry
    
    local accentCorner = Instance.new("UICorner")
    accentCorner.CornerRadius = UDim.new(1, 0)
    accentCorner.Parent = accentLine
    
    -- Animal name
    local nameLabel = Instance.new("TextLabel")
    nameLabel.Size = UDim2.new(1, -100, 0, 22)
    nameLabel.Position = UDim2.new(0, 15, 0, 10)
    nameLabel.BackgroundTransparency = 1
    nameLabel.Text = (isFav and "â˜… " or "") .. animalData.name
    nameLabel.TextColor3 = isFav and Color3.fromRGB(255, 200, 0) or Color3.fromRGB(255, 255, 255)
    nameLabel.TextSize = 16
    nameLabel.Font = Enum.Font.GothamBold
    nameLabel.TextXAlignment = Enum.TextXAlignment.Left
    nameLabel.Parent = entry
    
    -- Rarity
    local rarityLabel = Instance.new("TextLabel")
    rarityLabel.Size = UDim2.new(0, 120, 0, 18)
    rarityLabel.Position = UDim2.new(0, 15, 0, 36)
    rarityLabel.BackgroundTransparency = 1
    rarityLabel.Text = animalData.rarity
    rarityLabel.TextColor3 = rarityColor
    rarityLabel.TextSize = 13
    rarityLabel.Font = Enum.Font.GothamSemibold
    rarityLabel.TextXAlignment = Enum.TextXAlignment.Left
    rarityLabel.Parent = entry
    
    -- Generation
    local genLabel = Instance.new("TextLabel")
    genLabel.Size = UDim2.new(1, -15, 0, 20)
    genLabel.Position = UDim2.new(0, 15, 0, 65)
    genLabel.BackgroundTransparency = 1
    genLabel.Text = animalData.genText
    genLabel.TextColor3 = Color3.fromRGB(0, 200, 255)
    genLabel.TextSize = 15
    genLabel.Font = Enum.Font.GothamBold
    genLabel.TextXAlignment = Enum.TextXAlignment.Left
    genLabel.Parent = entry
    
    -- Mutation
    local mutationLabel = Instance.new("TextLabel")
    mutationLabel.Size = UDim2.new(0.5, -20, 0, 16)
    mutationLabel.Position = UDim2.new(0, 15, 0, 55)
    mutationLabel.BackgroundTransparency = 1
    mutationLabel.Text = animalData.mutation
    mutationLabel.TextColor3 = Color3.fromRGB(255, 100, 200)
    mutationLabel.TextSize = 12
    mutationLabel.Font = Enum.Font.Gotham
    mutationLabel.TextXAlignment = Enum.TextXAlignment.Left
    mutationLabel.Parent = entry
    
    -- Traits
    local traitsLabel = Instance.new("TextLabel")
    traitsLabel.Size = UDim2.new(0.5, -20, 0, 16)
    traitsLabel.Position = UDim2.new(0.5, 5, 0, 55)
    traitsLabel.BackgroundTransparency = 1
    traitsLabel.Text = animalData.traits
    traitsLabel.TextColor3 = Color3.fromRGB(100, 200, 255)
    traitsLabel.TextSize = 12
    traitsLabel.Font = Enum.Font.Gotham
    traitsLabel.TextXAlignment = Enum.TextXAlignment.Left
    traitsLabel.Parent = entry
    
    -- Teleport button
    local tpButton = Instance.new("TextButton")
    tpButton.Size = UDim2.new(0, 70, 0, 30)
    tpButton.Position = UDim2.new(1, -80, 0.5, -15)
    tpButton.BackgroundColor3 = Color3.fromRGB(0, 120, 215)
    tpButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    tpButton.Text = "TELEPORT"
    tpButton.Font = Enum.Font.GothamBold
    tpButton.TextSize = 12
    tpButton.Parent = entry
    
    local tpCorner = Instance.new("UICorner")
    tpCorner.CornerRadius = UDim.new(0, 6)
    tpCorner.Parent = tpButton
    
    tpButton.MouseButton1Click:Connect(function()
        teleportToAnimal(animalData)
    end)
    
    -- Favorite button
    local favButton = Instance.new("TextButton")
    favButton.Size = UDim2.new(0, 30, 0, 30)
    favButton.Position = UDim2.new(1, -115, 0.5, -15)
    favButton.BackgroundColor3 = isFav and Color3.fromRGB(255, 200, 0) or Color3.fromRGB(60, 60, 70)
    favButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    favButton.Text = "â˜…"
    favButton.Font = Enum.Font.GothamBold
    favButton.TextSize = 16
    favButton.Parent = entry
    
    local favCorner = Instance.new("UICorner")
    favCorner.CornerRadius = UDim.new(0, 6)
    favCorner.Parent = favButton
    
    favButton.MouseButton1Click:Connect(function()
        local wasFav = isFavorite(animalData.name)
        if wasFav then
            removeFavorite(animalData.name)
            favButton.BackgroundColor3 = Color3.fromRGB(60, 60, 70)
        else
            addFavorite(animalData.name)
            favButton.BackgroundColor3 = Color3.fromRGB(255, 200, 0)
        end
        updateAnimalsList()
        refreshFavoritesList()
    end)
    
    entry.Parent = parent
    return entry
end

-- Function to update statistics
function updateStats()
    if statsLabels.total then
        statsLabels.total.Text = tostring(stats.totalAnimals)
        statsLabels.value.Text = "$" .. (stats.totalValue or 0) .. "/s"
        statsLabels.highest.Text = "$" .. (stats.highestGen or 0) .. "/s"
        statsLabels.mutations.Text = tostring(stats.mutationCount or 0)
        statsLabels.traits.Text = tostring(stats.traitCount or 0)
    end
end

-- Function to refresh favorites list
function refreshFavoritesList()
    if not favoritesListContainer then return end
    
    for _, child in ipairs(favoritesListContainer:GetChildren()) do
        if child:IsA("Frame") then
            child:Destroy()
        end
    end
    
    for index, favName in ipairs(FAVORITES) do
        local entry = Instance.new("Frame")
        entry.BackgroundColor3 = Color3.fromRGB(40, 40, 50)
        entry.Size = UDim2.new(1, 0, 0, 40)
        
        local entryCorner = Instance.new("UICorner")
        entryCorner.CornerRadius = UDim.new(0, 6)
        entryCorner.Parent = entry
        
        local entryStroke = Instance.new("UIStroke")
        entryStroke.Color = Color3.fromRGB(80, 80, 120)
        entryStroke.Thickness = 1
        entryStroke.Parent = entry
        
        local indexLabel = Instance.new("TextLabel")
        indexLabel.Size = UDim2.new(0, 30, 1, 0)
        indexLabel.Position = UDim2.new(0, 5, 0, 0)
        indexLabel.BackgroundTransparency = 1
        indexLabel.Text = "#" .. index
        indexLabel.TextColor3 = Color3.fromRGB(255, 200, 0)
        indexLabel.TextSize = 14
        indexLabel.Font = Enum.Font.GothamBold
        indexLabel.TextXAlignment = Enum.TextXAlignment.Left
        indexLabel.Parent = entry
        
        local nameLabel = Instance.new("TextLabel")
        nameLabel.Size = UDim2.new(0.5, -40, 1, 0)
        nameLabel.Position = UDim2.new(0, 35, 0, 0)
        nameLabel.BackgroundTransparency = 1
        nameLabel.Text = favName
        nameLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
        nameLabel.TextSize = 14
        nameLabel.Font = Enum.Font.GothamSemibold
        nameLabel.TextXAlignment = Enum.TextXAlignment.Left
        nameLabel.Parent = entry
        
        local removeBtn = Instance.new("TextButton")
        removeBtn.Size = UDim2.new(0, 60, 0, 30)
        removeBtn.Position = UDim2.new(1, -65, 0.5, -15)
        removeBtn.BackgroundColor3 = Color3.fromRGB(200, 50, 50)
        removeBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
        removeBtn.Text = "REMOVE"
        removeBtn.Font = Enum.Font.GothamBold
        removeBtn.TextSize = 11
        removeBtn.Parent = entry
        
        local removeCorner = Instance.new("UICorner")
        removeCorner.CornerRadius = UDim.new(0, 4)
        removeCorner.Parent = removeBtn
        
        removeBtn.MouseButton1Click:Connect(function()
            removeFavorite(favName)
            refreshFavoritesList()
            updateAnimalsList()
            showNotification("Favorites", "Animal removed: " .. favName, 3)
        end)
        
        entry.Parent = favoritesListContainer
    end
end

-- Function to create the main interface
local function createCheixHubUI()
    -- Create main window
    CheixHubWindow = NothingLibrary.new({
        Title = "CHEIXHUB",
        Description = "Interface for Peroxide by Cheix",
        Keybind = Enum.KeyCode.RightControl,
        Logo = 'http://www.roblox.com/asset/?id=18898582662'
    })
    
    -- ============================================================
    -- TAB: ANIMALS
    -- ============================================================
    AnimalsTab = CheixHubWindow:NewTab({
        Title = "Animals",
        Description = "List of found brainrots",
        Icon = "rbxassetid://7733960981"
    })
    
    local LeftSection = AnimalsTab:NewSection({
        Title = "Animal List",
        Icon = "rbxassetid://7743869054",
        Position = "Left"
    })
    
    local RightSection = AnimalsTab:NewSection({
        Title = "Controls",
        Icon = "rbxassetid://7733964719",
        Position = "Right"
    })
    
    -- Search bar
    local searchContainer = Instance.new("Frame")
    searchContainer.BackgroundTransparency = 1
    searchContainer.Size = UDim2.new(1, 0, 0, 30)
    
    local searchBox = Instance.new("TextBox")
    searchBox.PlaceholderText = "Search animals, mutations, traits..."
    searchBox.Size = UDim2.new(1, -10, 1, 0)
    searchBox.Position = UDim2.new(0, 5, 0, 0)
    searchBox.BackgroundColor3 = Color3.fromRGB(30, 30, 40)
    searchBox.TextColor3 = Color3.fromRGB(255, 255, 255)
    searchBox.PlaceholderColor3 = Color3.fromRGB(150, 150, 180)
    searchBox.Text = ""
    searchBox.Parent = searchContainer
    
    local searchUICorner = Instance.new("UICorner")
    searchUICorner.CornerRadius = UDim.new(0, 5)
    searchUICorner.Parent = searchBox
    
    local searchUIStroke = Instance.new("UIStroke")
    searchUIStroke.Color = Color3.fromRGB(80, 80, 120)
    searchUIStroke.Thickness = 1
    searchUIStroke.Parent = searchBox
    
    -- Container for animal list
    animalListContainer = Instance.new("ScrollingFrame")
    animalListContainer.BackgroundTransparency = 1
    animalListContainer.Size = UDim2.new(1, 0, 0, 400)
    animalListContainer.Position = UDim2.new(0, 0, 0, 40)
    animalListContainer.ScrollBarThickness = 5
    animalListContainer.AutomaticCanvasSize = Enum.AutomaticSize.Y
    animalListContainer.ScrollingDirection = Enum.ScrollingDirection.Y
    
    local animalListLayout = Instance.new("UIListLayout")
    animalListLayout.Padding = UDim.new(0, 5)
    animalListLayout.SortOrder = Enum.SortOrder.LayoutOrder
    animalListLayout.Parent = animalListContainer
    
    -- Add elements to left section
    LeftSection:NewTitle("Search")
    LeftSection:AddCustom(searchContainer)
    LeftSection:NewTitle("Found Animals")
    LeftSection:AddCustom(animalListContainer)
    
    -- Controls in right section
    RightSection:NewToggle({
        Title = "Show All Rarities",
        Default = CONFIG.SHOW_ALL_RARITIES,
        Callback = function(value)
            CONFIG.SHOW_ALL_RARITIES = value
            updateAnimalsList()
        end,
    })
    
    RightSection:NewToggle({
        Title = "Only with Mutations",
        Default = CONFIG.SHOW_MUTATIONS_ONLY,
        Callback = function(value)
            CONFIG.SHOW_MUTATIONS_ONLY = value
            updateAnimalsList()
        end,
    })
    
    RightSection:NewToggle({
        Title = "Only with Traits",
        Default = CONFIG.SHOW_TRAITS_ONLY,
        Callback = function(value)
            CONFIG.SHOW_TRAITS_ONLY = value
            updateAnimalsList()
        end,
    })
    
    RightSection:NewSlider({
        Title = "Minimum Generation",
        Min = 0,
        Max = 100000000,
        Default = CONFIG.MIN_GEN_VALUE,
        Callback = function(value)
            CONFIG.MIN_GEN_VALUE = value
            updateAnimalsList()
        end,
    })
    
    RightSection:NewButton({
        Title = "Teleport to Highest",
        Callback = function()
            teleportToHighest()
        end,
    })
    
    RightSection:NewButton({
        Title = "Rescan All",
        Callback = function()
            rescanAllPlots()
        end,
    })
    
    RightSection:NewButton({
        Title = "Update List",
        Callback = function()
            updateAnimalsList()
            showNotification("CheixHub", "âœ“ List updated", 2)
        end,
    })
    
    -- ============================================================
    -- TAB: FAVORITES
    -- ============================================================
    FavoritesTab = CheixHubWindow:NewTab({
        Title = "Favorites",
        Description = "Animal priority system",
        Icon = "rbxassetid://7733964719"
    })
    
    local FavLeftSection = FavoritesTab:NewSection({
        Title = "Favorites List",
        Icon = "rbxassetid://7743869054",
        Position = "Left"
    })
    
    local FavRightSection = FavoritesTab:NewSection({
        Title = "Configuration",
        Icon = "rbxassetid://7733964719",
        Position = "Right"
    })
    
    FavLeftSection:NewTitle("Favorite Animals")
    FavLeftSection:NewToggle({
        Title = "Favorites Priority",
        Default = CONFIG.FAVORITES_PRIORITY_ENABLED,
        Callback = function(value)
            CONFIG.FAVORITES_PRIORITY_ENABLED = value
            showNotification("CheixHub", 
                value and "âœ“ Favorites priority enabled" 
                or "âœ— Favorites priority disabled", 
                3)
        end,
    })
    
    -- Field to add favorites
    local addFavoriteContainer = Instance.new("Frame")
    addFavoriteContainer.BackgroundTransparency = 1
    addFavoriteContainer.Size = UDim2.new(1, 0, 0, 40)
    
    local addFavoriteBox = Instance.new("TextBox")
    addFavoriteBox.PlaceholderText = "Animal name (ex: Garama, Dragon...)"
    addFavoriteBox.Size = UDim2.new(0.7, 0, 1, 0)
    addFavoriteBox.Position = UDim2.new(0, 0, 0, 0)
    addFavoriteBox.BackgroundColor3 = Color3.fromRGB(30, 30, 40)
    addFavoriteBox.TextColor3 = Color3.fromRGB(255, 255, 255)
    addFavoriteBox.PlaceholderColor3 = Color3.fromRGB(150, 150, 180)
    addFavoriteBox.Text = ""
    addFavoriteBox.Parent = addFavoriteContainer
    
    local addFavoriteCorner = Instance.new("UICorner")
    addFavoriteCorner.CornerRadius = UDim.new(0, 5)
    addFavoriteCorner.Parent = addFavoriteBox
    
    local addFavoriteStroke = Instance.new("UIStroke")
    addFavoriteStroke.Color = Color3.fromRGB(80, 80, 120)
    addFavoriteStroke.Thickness = 1
    addFavoriteStroke.Parent = addFavoriteBox
    
    local addFavoriteBtn = Instance.new("TextButton")
    addFavoriteBtn.Size = UDim2.new(0.25, -5, 1, 0)
    addFavoriteBtn.Position = UDim2.new(0.75, 5, 0, 0)
    addFavoriteBtn.BackgroundColor3 = Color3.fromRGB(0, 120, 215)
    addFavoriteBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
    addFavoriteBtn.Text = "ADD"
    addFavoriteBtn.Font = Enum.Font.GothamBold
    addFavoriteBtn.Parent = addFavoriteContainer
    
    local addFavoriteBtnCorner = Instance.new("UICorner")
    addFavoriteBtnCorner.CornerRadius = UDim.new(0, 5)
    addFavoriteBtnCorner.Parent = addFavoriteBtn
    
    FavLeftSection:AddCustom(addFavoriteContainer)
    
    -- Container for favorites list
    favoritesListContainer = Instance.new("ScrollingFrame")
    favoritesListContainer.BackgroundTransparency = 1
    favoritesListContainer.Size = UDim2.new(1, 0, 0, 300)
    favoritesListContainer.Position = UDim2.new(0, 0, 0, 50)
    favoritesListContainer.ScrollBarThickness = 5
    favoritesListContainer.AutomaticCanvasSize = Enum.AutomaticSize.Y
    favoritesListContainer.ScrollingDirection = Enum.ScrollingDirection.Y
    
    local favoritesListLayout = Instance.new("UIListLayout")
    favoritesListLayout.Padding = UDim.new(0, 5)
    favoritesListLayout.SortOrder = Enum.SortOrder.LayoutOrder
    favoritesListLayout.Parent = favoritesListContainer
    
    FavLeftSection:AddCustom(favoritesListContainer)
    
    -- Configuration in right section
    FavRightSection:NewTitle("Priority Animals")
    
    for _, animalName in ipairs(PRIORITY_ANIMALS) do
        FavRightSection:NewToggle({
            Title = animalName,
            Default = false,
            Callback = function(value)
                if value then
                    addFavorite(animalName)
                else
                    removeFavorite(animalName)
                end
                refreshFavoritesList()
            end,
        })
    end
    
    -- ============================================================
    -- TAB: ACTIONS
    -- ============================================================
    ActionsTab = CheixHubWindow:NewTab({
        Title = "Actions",
        Description = "Tools and features",
        Icon = "rbxassetid://8997385628"
    })
    
    local ActionsLeftSection = ActionsTab:NewSection({
        Title = "Auto-Steal",
        Icon = "rbxassetid://7743869054",
        Position = "Left"
    })
    
    local ActionsRightSection = ActionsTab:NewSection({
        Title = "Utilities",
        Icon = "rbxassetid://7733964719",
        Position = "Right"
    })
    
    -- Auto-Steal
    ActionsLeftSection:NewToggle({
        Title = "Auto-Steal Best Gen",
        Default = CONFIG.AUTO_STEAL_ENABLED,
        Callback = function(value)
            CONFIG.AUTO_STEAL_ENABLED = value
            if value then CONFIG.AUTO_STEAL_NEAREST_ENABLED = false end
            showNotification("Auto-Steal", 
                value and "âœ“ Auto-Steal (Best) enabled" 
                or "âœ— Auto-Steal (Best) disabled", 
                3)
        end,
    })
    
    ActionsLeftSection:NewToggle({
        Title = "Auto-Steal Nearest",
        Default = CONFIG.AUTO_STEAL_NEAREST_ENABLED,
        Callback = function(value)
            CONFIG.AUTO_STEAL_NEAREST_ENABLED = value
            if value then CONFIG.AUTO_STEAL_ENABLED = false end
            showNotification("Auto-Steal", 
                value and "âœ“ Auto-Steal (Nearest) enabled" 
                or "âœ— Auto-Steal (Nearest) disabled", 
                3)
        end,
    })
    
    ActionsLeftSection:NewToggle({
        Title = "Auto-Steal Priority",
        Default = CONFIG.AUTO_STEAL_PRIORITY_ENABLED,
        Callback = function(value)
            CONFIG.AUTO_STEAL_PRIORITY_ENABLED = value
            showNotification("Auto-Steal", 
                value and "âœ“ Priority enabled" 
                or "âœ— Priority disabled", 
                3)
        end,
    })
    
    ActionsLeftSection:NewToggle({
        Title = "Speed While Stealing",
        Default = CONFIG.STEAL_SPEED_ENABLED,
        Callback = function(value)
            CONFIG.STEAL_SPEED_ENABLED = value
            showNotification("Speed", 
                value and "âœ“ Speed enabled" 
                or "âœ— Speed disabled", 
                3)
        end,
    })
    
    ActionsLeftSection:NewToggle({
        Title = "No Animation While Stealing",
        Default = CONFIG.STEAL_DISABLE_ANIM_ENABLED,
        Callback = function(value)
            CONFIG.STEAL_DISABLE_ANIM_ENABLED = value
            showNotification("Animations", 
                value and "âœ“ Animations disabled" 
                or "âœ— Animations enabled", 
                3)
        end,
    })
    
    ActionsLeftSection:NewToggle({
        Title = "Predictive Steal",
        Default = CONFIG.PREDICTIVE_STEAL,
        Callback = function(value)
            CONFIG.PREDICTIVE_STEAL = value
            showNotification("Auto-Steal", 
                value and "âœ“ Predictive steal enabled" 
                or "âœ— Predictive steal disabled", 
                3)
        end,
    })
    
    -- Utilities
    ActionsRightSection:NewToggle({
        Title = "Animal ESP",
        Default = CONFIG.ESP_ENABLED,
        Callback = function(value)
            CONFIG.ESP_ENABLED = value
            refreshAllESP()
            showNotification("ESP", 
                value and "âœ“ ESP enabled" 
                or "âœ— ESP disabled", 
                3)
        end,
    })
    
    ActionsRightSection:NewToggle({
        Title = "Player ESP",
        Default = CONFIG.ESP_PLAYERS_ENABLED,
        Callback = function(value)
            CONFIG.ESP_PLAYERS_ENABLED = value
            refreshPlayerESP()
            showNotification("ESP", 
                value and "âœ“ Player ESP enabled" 
                or "âœ— Player ESP disabled", 
                3)
        end,
    })
    
    ActionsRightSection:NewToggle({
        Title = "Invisible Base Walls",
        Default = CONFIG.INVISIBLE_BASE_WALLS_ENABLED,
        Callback = function(value)
            CONFIG.INVISIBLE_BASE_WALLS_ENABLED = value
            if value then
                enableInvisibleBaseWalls()
            else
                disableInvisibleBaseWalls()
            end
            showNotification("Xray", 
                value and "âœ“ Xray enabled" 
                or "âœ— Xray disabled", 
                3)
        end,
    })
    
    ActionsRightSection:NewToggle({
        Title = "Floor Steal",
        Default = CONFIG.FLOOR_STEAL_ENABLED,
        Callback = function(value)
            CONFIG.FLOOR_STEAL_ENABLED = value
            if value then
                startFloorSteal()
            else
                stopFloorSteal()
            end
            showNotification("Floor Steal", 
                value and "âœ“ Floor Steal enabled" 
                or "âœ— Floor Steal disabled", 
                3)
        end,
    })
    
    ActionsRightSection:NewToggle({
        Title = "Safe Teleport",
        Default = CONFIG.SAFE_TELEPORT,
        Callback = function(value)
            CONFIG.SAFE_TELEPORT = value
            showNotification("Teleport", 
                value and "âœ“ Safe teleport enabled" 
                or "âœ— Safe teleport disabled", 
                3)
        end,
    })
    
    ActionsRightSection:NewButton({
        Title = "Enable Desync V3",
        Callback = function()
            enableDesync()
        end,
    })
    
    ActionsRightSection:NewButton({
        Title = "Instant Cloner",
        Callback = function()
            instantCloner()
        end,
    })
    
    ActionsRightSection:NewButton({
        Title = "Auto-Teleport on Start",
        Callback = function()
            autoTeleportOnStart()
        end,
    })
    
    ActionsRightSection:NewButton({
        Title = "Kick Self",
        Callback = function()
            kickSelf()
        end,
    })
    
    ActionsRightSection:NewButton({
        Title = "Rejoin Server",
        Callback = function()
            rejoinServer()
        end,
    })
    
    -- ============================================================
    -- TAB: STATISTICS
    -- ============================================================
    StatsTab = CheixHubWindow:NewTab({
        Title = "Statistics",
        Description = "Server statistics",
        Icon = "rbxassetid://7733964719"
    })
    
    local StatsLeftSection = StatsTab:NewSection({
        Title = "Statistics",
        Icon = "rbxassetid://7743869054",
        Position = "Left"
    })
    
    local StatsRightSection = StatsTab:NewSection({
        Title = "Optimization",
        Icon = "rbxassetid://7733964719",
        Position = "Right"
    })
    
    -- Create containers for statistics
    local statsGrid = Instance.new("Frame")
    statsGrid.BackgroundTransparency = 1
    statsGrid.Size = UDim2.new(1, 0, 0, 200)
    
    local statsUIListLayout = Instance.new("UIGridLayout")
    statsUIListLayout.CellPadding = UDim2.new(0, 10, 0, 10)
    statsUIListLayout.CellSize = UDim2.new(0.5, -5, 0, 50)
    statsUIListLayout.Parent = statsGrid
    
    -- Functions to create stat boxes
    local function createStatBox(parent, title, initialValue, color)
        local statBox = Instance.new("Frame")
        statBox.BackgroundColor3 = Color3.fromRGB(30, 30, 40)
        statBox.Size = UDim2.new(1, 0, 0, 50)
        
        local statCorner = Instance.new("UICorner")
        statCorner.CornerRadius = UDim.new(0, 8)
        statCorner.Parent = statBox
        
        local statStroke = Instance.new("UIStroke")
        statStroke.Color = color or Color3.fromRGB(80, 80, 120)
        statStroke.Thickness = 1
        statStroke.Parent = statBox
        
        local titleLabel = Instance.new("TextLabel")
        titleLabel.Size = UDim2.new(1, -10, 0, 20)
        titleLabel.Position = UDim2.new(0, 5, 0, 5)
        titleLabel.BackgroundTransparency = 1
        titleLabel.Text = title
        titleLabel.TextColor3 = Color3.fromRGB(200, 200, 220)
        titleLabel.TextSize = 12
        titleLabel.Font = Enum.Font.Gotham
        titleLabel.TextXAlignment = Enum.TextXAlignment.Left
        titleLabel.Parent = statBox
        
        local valueLabel = Instance.new("TextLabel")
        valueLabel.Size = UDim2.new(1, -10, 0, 25)
        valueLabel.Position = UDim2.new(0, 5, 0, 25)
        valueLabel.BackgroundTransparency = 1
        valueLabel.Text = initialValue
        valueLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
        valueLabel.TextSize = 18
        valueLabel.Font = Enum.Font.GothamBold
        valueLabel.TextXAlignment = Enum.TextXAlignment.Left
        valueLabel.Parent = statBox
        
        statBox.Parent = parent
        return valueLabel
    end
    
    -- Create stat boxes
    statsLabels.total = createStatBox(statsGrid, "Total Animals", "0", Color3.fromRGB(0, 150, 255))
    statsLabels.value = createStatBox(statsGrid, "Total Value/s", "$0", Color3.fromRGB(0, 200, 100))
    statsLabels.highest = createStatBox(statsGrid, "Best Generation", "$0/s", Color3.fromRGB(255, 200, 0))
    statsLabels.mutations = createStatBox(statsGrid, "With Mutations", "0", Color3.fromRGB(200, 0, 255))
    statsLabels.traits = createStatBox(statsGrid, "With Traits", "0", Color3.fromRGB(0, 200, 255))
    
    StatsLeftSection:AddCustom(statsGrid)
    
    -- Optimization in right section
    StatsRightSection:NewToggle({
        Title = "Tuff Optimizer",
        Default = CONFIG.OptimizerEnabled,
        Callback = function(value)
            CONFIG.OptimizerEnabled = value
            if value then
                showNotification("Optimizer", "âš  Optimizer requires separate module", 3)
            else
                showNotification("Optimizer", "âœ— Optimizer disabled", 3)
            end
        end,
    })
    
    StatsRightSection:NewToggle({
        Title = "Anti-Lag (No FPS Killers)",
        Default = CONFIG.ANTI_LAG_ENABLED,
        Callback = function(value)
            CONFIG.ANTI_LAG_ENABLED = value
            showNotification("Anti-Lag", 
                value and "âœ“ Anti-Lag enabled" 
                or "âœ— Anti-Lag disabled", 
                3)
        end,
    })
    
    StatsRightSection:NewToggle({
        Title = "Anti-Bee & Anti-Disco",
        Default = CONFIG.ANTI_BEE_DISCO_ENABLED,
        Callback = function(value)
            CONFIG.ANTI_BEE_DISCO_ENABLED = value
            showNotification("Anti-Effects", 
                value and "âœ“ Anti-Bee/Disco enabled" 
                or "âœ— Anti-Bee/Disco disabled", 
                3)
        end,
    })
    
    StatsRightSection:NewToggle({
        Title = "Anti-Ragdoll v1 (Freeze Only)",
        Default = CONFIG.ANTI_RAGDOLL_V1_ENABLED,
        Callback = function(value)
            CONFIG.ANTI_RAGDOLL_V1_ENABLED = value
            showNotification("Anti-Ragdoll", 
                value and "âœ“ Anti-Ragdoll v1 enabled" 
                or "âœ— Anti-Ragdoll v1 disabled", 
                3)
        end,
    })
    
    StatsRightSection:NewToggle({
        Title = "Anti-Ragdoll v2 (Moveable)",
        Default = CONFIG.ANTI_RAGDOLL_V2_ENABLED,
        Callback = function(value)
            CONFIG.ANTI_RAGDOLL_V2_ENABLED = value
            showNotification("Anti-Ragdoll", 
                value and "âœ“ Anti-Ragdoll v2 enabled" 
                or "âœ— Anti-Ragdoll v2 disabled", 
                3)
        end,
    })
    
    -- Setup events
    searchBox:GetPropertyChangedSignal("Text"):Connect(function()
        searchQuery = searchBox.Text
        updateAnimalsList()
    end)
    
    addFavoriteBtn.MouseButton1Click:Connect(function()
        local animalName = addFavoriteBox.Text:match("^%s*(.-)%s*$")
        if animalName ~= "" then
            if addFavorite(animalName) then
                addFavoriteBox.Text = ""
                refreshFavoritesList()
            end
        else
            showNotification("CheixHub", "Please enter an animal name!", 3)
        end
    end)
    
    addFavoriteBox.FocusLost:Connect(function(enterPressed)
        if enterPressed then
            local animalName = addFavoriteBox.Text:match("^%s*(.-)%s*$")
            if animalName ~= "" then
                if addFavorite(animalName) then
                    addFavoriteBox.Text = ""
                    refreshFavoritesList()
                end
            end
        end
    end)
    
    showNotification("CheixHub", "Interface loaded successfully!", 3)
end

-- ============================================================
-- INITIALIZATION
-- ============================================================

-- Load configuration and favorites
pcall(loadConfig)
pcall(loadFavorites)

-- Create the interface
createCheixHubUI()

-- Initialize scanner and other functions
if not game:IsLoaded() then
    game.Loaded:Wait()
end

task.spawn(function()
    task.wait(2)
    initializePlotScanner()
    autoStealLoop()
    setupPromptCacheCleanup()
    
    -- Auto-enable features based on config
    if CONFIG.AUTO_TP_ENABLED then
        task.spawn(autoTeleportOnStart)
    end
    
    if CONFIG.AUTO_DESYNC_ENABLED then
        task.wait(1)
        enableDesync()
    end
    
    if CONFIG.INVISIBLE_BASE_WALLS_ENABLED then
        enableInvisibleBaseWalls()
    end
    
    if CONFIG.FLOOR_STEAL_ENABLED then
        startFloorSteal()
    end
    
    if CONFIG.ANTI_LAG_ENABLED then
        -- Anti-Lag would be initialized here if module was available
        showNotification("CheixHub", "Anti-Lag feature placeholder", 3)
    end
end)

-- Keybind system
S.UserInputService.InputBegan:Connect(function(input, gameProcessed)
    if gameProcessed then return end
    
    if input.KeyCode == CONFIG.TELEPORT_KEYBIND then
        teleportToHighest()
    elseif input.KeyCode == CONFIG.TOGGLE_GUI_KEYBIND then
        -- NOTHING handles its own toggle with RightControl
    elseif input.KeyCode == CONFIG.INSTANT_CLONER_KEYBIND then
        instantCloner()
    elseif input.KeyCode == CONFIG.KICK_SELF_KEYBIND then
        kickSelf()
    elseif input.KeyCode == CONFIG.REJOIN_KEYBIND then
        rejoinServer()
    elseif input.KeyCode == CONFIG.FLOOR_STEAL_KEYBIND then
        CONFIG.FLOOR_STEAL_ENABLED = not CONFIG.FLOOR_STEAL_ENABLED
        if CONFIG.FLOOR_STEAL_ENABLED then
            startFloorSteal()
            showNotification("Floor Steal", "âœ“ Floor Steal enabled", 3)
        else
            stopFloorSteal()
            showNotification("Floor Steal", "âœ— Floor Steal disabled", 3)
        end
    elseif input.KeyCode == CONFIG.DESYNC_KEYBIND then
        enableDesync()
    end
end)

-- Setup cleanup
game:GetService("Players").LocalPlayer.CharacterAdded:Connect(function()
    task.wait(1)
    originalAnimIds = {}
    animateScript = nil
    cacheOriginalAnimations()
end)

-- Player ESP heartbeat
S.RunService.Heartbeat:Connect(playerESPHeartbeat)

-- Show startup notification
showNotification("CheixHub", "âœ“ Interface loaded! Press RightControl to open/close", 5)

-- Setup prompt cache cleanup
local function setupPromptCacheCleanup()
    local plots = workspace:WaitForChild("Plots", 8)
    if not plots then return end
    
    plots.ChildRemoved:Connect(function(plot)
        for uid, prompt in pairs(PromptMemoryCache) do
            if uid:find(plot.Name) then
                PromptMemoryCache[uid] = nil
            end
        end
    end)
end

-- Pre-build callbacks in background
task.spawn(function()
    while task.wait() do
        if CONFIG.AUTO_STEAL_ENABLED or CONFIG.AUTO_STEAL_NEAREST_ENABLED then
            prebuildStealCallbacks()
        end
    end
end)